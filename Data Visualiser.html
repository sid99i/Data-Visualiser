<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data to Flowchart Visualizer</title>
    <!-- Tailwind CSS with Config for Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Mermaid JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <!-- SVG Pan Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Diagram Container - Light Mode */
        #diagram-container {
            height: calc(100vh - 4rem);
            overflow: hidden;
            background-color: #f8fafc; /* slate-50 */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            transition: background-color 0.3s ease;
        }

        /* Diagram Container - Dark Mode */
        .dark #diagram-container {
            background-color: #0f172a; /* slate-900 */
            background-image: radial-gradient(#334155 1px, transparent 1px);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 h-screen flex flex-col md:flex-row overflow-hidden font-sans transition-colors duration-300">

    <!-- Left Panel: Input -->
    <div class="w-full md:w-1/3 flex flex-col border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-lg z-10 transition-colors duration-300">
        <!-- Header -->
        <div class="p-4 bg-blue-900 dark:bg-blue-950 text-white flex justify-between items-center shadow-md">
            <h1 class="font-bold text-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                Data Visualizer
            </h1>
            
            <!-- Theme Toggle Button -->
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-white/10 transition-colors focus:outline-none" title="Toggle Dark Mode">
                <!-- Sun Icon (for Dark Mode) -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (for Light Mode) -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>

        <div class="flex-1 p-4 flex flex-col gap-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Input JSON or Python Dict</label>
                <textarea id="jsonInput" 
                    class="w-full h-64 md:h-96 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 resize-none shadow-inner transition-colors"
                    placeholder='{"key": "value", "list": [1, 2, 3]}'></textarea>
            </div>

            <div class="flex gap-2">
                <button onclick="visualize()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-sm flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    Visualize
                </button>
                <button onclick="loadSample()" 
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg transition-colors">
                    Sample
                </button>
            </div>

            <!-- Error Message Box -->
            <div id="errorBox" class="hidden p-3 bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 text-red-700 dark:text-red-300 text-sm rounded transition-colors">
                <p class="font-bold">Error parsing data:</p>
                <p id="errorMessage" class="mt-1 font-mono text-xs"></p>
            </div>
            
            <div class="mt-auto text-xs text-gray-400 dark:text-gray-500 text-center">
                Supports standard JSON and basic Python Dictionary format.
            </div>
        </div>
    </div>

    <!-- Right Panel: Visualization -->
    <div class="w-full md:w-2/3 relative flex flex-col">
        <div class="absolute top-4 right-4 z-20 flex gap-2">
            <button onclick="resetZoom()" class="bg-white dark:bg-gray-800 p-2 rounded-full shadow-md text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600 transition-colors" title="Reset View">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
            </button>
        </div>
        
        <!-- Dynamic Floating Legend (Bottom Right) -->
        <div id="dynamic-legend" class="absolute bottom-4 right-4 z-20 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-3 hidden flex-col gap-2 min-w-[140px] text-xs font-medium">
            <!-- Legend items will be injected here via JS -->
        </div>

        <div id="diagram-container" class="flex justify-center items-center w-full h-full">
            <div id="mermaid-output" class="w-full h-full flex justify-center items-center text-gray-400 dark:text-gray-500 transition-colors">
                <span class="text-lg">Enter data and click Visualize to generate chart.</span>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'base',
            securityLevel: 'loose',
            flowchart: {
                curve: 'basis',
                padding: 15
            }
        });

        let panZoomInstance = null;

        // Theme Handling
        const htmlElement = document.documentElement;
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        function toggleTheme() {
            htmlElement.classList.toggle('dark');
            const isDark = htmlElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateIcons(isDark);
            
            // Re-render graph if one exists
            if (document.getElementById('jsonInput').value.trim() !== '') {
                 visualize(false); 
            }
        }

        function updateIcons(isDark) {
            if (isDark) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
            updateIcons(true);
        } else {
            updateIcons(false);
        }

        function loadSample() {
            const sampleData = {
                "Project": "Web App",
                "IsActive": true,
                "Version": 2.5,
                "Modules": ["Auth", "Database", "UI"],
                "Details": {
                    "Lead": null,
                    "Priority": "High"
                }
            };
            document.getElementById('jsonInput').value = JSON.stringify(sampleData, null, 4);
            visualize();
        }

        function sanitize(str) {
            if (str === null) return 'null';
            if (str === undefined) return 'undefined';
            let s = String(str)
                .replace(/["(){}\[\]]/g, '') // Remove chars that break mermaid syntax
                .replace(/\s+/g, ' ')        // Collapse whitespace
                .trim();
            
            // Truncate long strings
            if (s.length > 50) {
                return s.substring(0, 47) + '...';
            }
            return s;
        }

        function cleanInput(input) {
            let s = input
                .replace(/[\u2018\u2019]/g, "'")
                .replace(/[\u201C\u201D]/g, '"');
            s = s.replace(/[\u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000\uFEFF]/g, " ");
            return s;
        }

        function preprocessInput(input) {
            let processed = input
                .replace(/'/g, '"')
                .replace(/\bNone\b/g, 'null')
                .replace(/\bTrue\b/g, 'true')
                .replace(/\bFalse\b/g, 'false');
            processed = processed.replace(/,\s*([\]}])/g, '$1');
            return processed;
        }

        let nodeCounter = 0;

        // Determines the class for the Value node
        function getValueClass(val) {
            if (val === null) return 'nullValClass';
            const type = typeof val;
            if (type === 'string') return 'stringValClass';
            if (type === 'number') return 'numberValClass';
            if (type === 'boolean') return 'boolValClass';
            return 'stringValClass'; // Default
        }

        // Generate Mermaid and collect found types
        function generateMermaid(data, collectedTypes, parentId = null) {
            let syntax = '';
            
            if (typeof data === 'object' && data !== null) {
                const keys = Object.keys(data);
                
                keys.forEach(key => {
                    const val = data[key];
                    const nodeId = `N${nodeCounter++}`;
                    const safeKey = sanitize(key);
                    
                    // Determine Key Color based on what it holds
                    let currentKeyClass = 'keyClass'; // Default Blue
                    if (Array.isArray(val)) {
                        currentKeyClass = 'listKeyClass'; // Green if it's a list
                        collectedTypes.add('listKeyClass');
                    } else {
                        collectedTypes.add('keyClass');
                    }

                    if (parentId) {
                        syntax += `${parentId} --> ${nodeId}[${safeKey}]:::${currentKeyClass}\n`;
                    } else {
                        syntax += `${nodeId}[${safeKey}]:::${currentKeyClass}\n`;
                    }

                    if (typeof val === 'object' && val !== null) {
                        syntax += generateMermaid(val, collectedTypes, nodeId);
                    } else {
                        const valId = `V${nodeCounter++}`;
                        const safeVal = sanitize(val);
                        const valClass = getValueClass(val);
                        collectedTypes.add(valClass); // Record this value type
                        syntax += `${nodeId} --> ${valId}(${safeVal}):::${valClass}\n`;
                    }
                });
            } else {
                // Root is a primitive
                const valId = `V${nodeCounter++}`;
                const valClass = getValueClass(data);
                collectedTypes.add(valClass);
                syntax += `${valId}(${sanitize(data)}):::${valClass}\n`;
            }

            return syntax;
        }

        function updateLegend(foundTypes) {
            const legendContainer = document.getElementById('dynamic-legend');
            legendContainer.innerHTML = ''; // Clear existing
            
            // Definition of all possible items
            const legendItems = [
                { id: 'keyClass', label: 'Object Key', color: '#1e40af' }, // Blue 800
                { id: 'listKeyClass', label: 'List Key', color: '#15803d' }, // Green 700
                { id: 'stringValClass', label: 'String', color: '#bfdbfe' }, // Blue 200
                { id: 'numberValClass', label: 'Number', color: '#fed7aa' }, // Orange 200
                { id: 'boolValClass', label: 'Boolean', color: '#e9d5ff' }, // Purple 200
                { id: 'nullValClass', label: 'Null', color: '#e2e8f0' } // Slate 200
            ];

            let hasItems = false;

            legendItems.forEach(item => {
                if (foundTypes.has(item.id)) {
                    hasItems = true;
                    // Create legend item HTML
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2';
                    
                    const circle = document.createElement('span');
                    circle.className = 'w-3 h-3 rounded-full shadow-sm';
                    circle.style.backgroundColor = item.color;
                    
                    const label = document.createElement('span');
                    label.className = 'dark:text-gray-200';
                    label.textContent = item.label;

                    row.appendChild(circle);
                    row.appendChild(label);
                    legendContainer.appendChild(row);
                }
            });

            if (hasItems) {
                legendContainer.classList.remove('hidden');
                legendContainer.classList.add('flex');
            } else {
                legendContainer.classList.add('hidden');
                legendContainer.classList.remove('flex');
            }
        }

        async function visualize(shouldResetZoom = true) {
            const inputField = document.getElementById('jsonInput');
            let inputStr = inputField.value;
            const errorBox = document.getElementById('errorBox');
            const errorMessage = document.getElementById('errorMessage');
            const outputDiv = document.getElementById('mermaid-output');
            const isDark = htmlElement.classList.contains('dark');
            const legendContainer = document.getElementById('dynamic-legend');

            errorBox.classList.add('hidden');
            legendContainer.classList.add('hidden'); // Hide until we know what's in data

            if (!inputStr.trim()) {
                outputDiv.innerHTML = `<span class="text-lg ${isDark ? 'text-gray-500' : 'text-gray-400'}">Enter data and click Visualize to generate chart.</span>`;
                return;
            }

            let jsonData;

            // Strategy 1: Direct JSON Parse
            try {
                jsonData = JSON.parse(inputStr);
            } catch (e1) {
                // Strategy 2: Clean invisible characters (NBSP) and Smart Quotes
                try {
                    const cleanStr = cleanInput(inputStr);
                    jsonData = JSON.parse(cleanStr);
                } catch (e2) {
                    // Strategy 3: Python Dict conversion
                    try {
                        const cleanStr = cleanInput(inputStr);
                        const processed = preprocessInput(cleanStr);
                        jsonData = JSON.parse(processed);
                    } catch (e3) {
                        errorBox.classList.remove('hidden');
                        errorMessage.innerText = "Parsing failed.\nDetails: " + e3.message;
                        return;
                    }
                }
            }

            nodeCounter = 0;
            // Set to track which types exist in the current dataset
            let foundTypes = new Set();
            
            let graphDefinition = 'graph LR\n';
            
            // --- DEFINE COLORS ---
            graphDefinition += `classDef keyClass fill:#1e40af,stroke:#1e3a8a,stroke-width:2px,color:white,rx:5,ry:5;\n`;
            graphDefinition += `classDef listKeyClass fill:#15803d,stroke:#14532d,stroke-width:2px,color:white,rx:5,ry:5;\n`;
            graphDefinition += `classDef stringValClass fill:#bfdbfe,stroke:#3b82f6,stroke-width:2px,color:#172554,rx:10,ry:10;\n`;
            graphDefinition += `classDef numberValClass fill:#fed7aa,stroke:#f97316,stroke-width:2px,color:#431407,rx:10,ry:10;\n`;
            graphDefinition += `classDef boolValClass fill:#e9d5ff,stroke:#a855f7,stroke-width:2px,color:#3b0764,rx:10,ry:10;\n`;
            graphDefinition += `classDef nullValClass fill:#e2e8f0,stroke:#64748b,stroke-width:2px,color:#0f172a,rx:10,ry:10;\n`;

            const edgeColor = isDark ? '#cbd5e1' : '#334155'; 
            graphDefinition += `linkStyle default stroke:${edgeColor},stroke-width:2px;\n`;

            // Pass the set to track types
            graphDefinition += generateMermaid(jsonData, foundTypes);

            // Update UI Legend based on found types
            updateLegend(foundTypes);

            try {
                outputDiv.innerHTML = ''; 
                const id = 'mermaid-' + Date.now();
                
                // Render Graph
                const { svg } = await mermaid.render(id, graphDefinition);
                outputDiv.innerHTML = svg;

                const svgElement = outputDiv.querySelector('svg');
                
                if(svgElement) {
                    svgElement.style.width = '100%';
                    svgElement.style.height = '100%';
                    svgElement.style.maxWidth = 'none'; // FIX: Remove default max-width constraint

                    panZoomInstance = svgPanZoom(svgElement, {
                        zoomEnabled: true,
                        controlIconsEnabled: false,
                        fit: true,
                        center: true,
                        minZoom: 0.1,
                        maxZoom: 10
                    });
                }

            } catch (e) {
                console.error(e);
                errorBox.classList.remove('hidden');
                errorMessage.textContent = "Graph generation failed. The data structure might be too deep or complex.";
            }
        }

        function resetZoom() {
            if (panZoomInstance) {
                panZoomInstance.reset();
                panZoomInstance.fit();
                panZoomInstance.center();
            }
        }

        window.addEventListener('resize', () => {
            if (panZoomInstance) {
                panZoomInstance.resize();
                panZoomInstance.fit();
                panZoomInstance.center();
            }
        });
    </script>
</body>
</html>
